
alphabet = \
[ [ [False, True,  True,  True,  False],  # { A }
     [True,  False, False, False, True],
     [True,  True,  True,  True,  True],
     [True,  False, False, False, True],
     [True,  False, False, False, True] ],
   [ [True,  True,  True,  True,  False],  # { B }
     [True,  False, False, False, True],
     [True,  True,  True,  True,  False],
     [True,  False, False, False, True],
     [True,  True,  True,  True,  False] ],
   [ [False, True,  True,  True,  True],   # { C }
     [True,  False, False, False, False],
     [True,  False, False, False, False],
     [True,  False, False, False, False],
     [False, True,  True,  True,  True] ],
   [ [True,  True,  True,  True,  False],  # { D }
     [True,  False, False, False, True],
     [True,  False, False, False, True],
     [True,  False, False, False, True],
     [True,  True,  True,  True,  False] ],
   [ [True,  True,  True,  True,  True],   # { E }
     [True,  False, False, False, False],
     [True,  True,  True,  False, False],
     [True,  False, False, False, False],
     [True,  True,  True,  True,  True] ],
   [ [True,  True,  True,  True,  True],   # { F }
     [True,  False, False, False, False],
     [True,  True,  True,  False, False],
     [True,  False, False, False, False],
     [True,  False, False, False, False] ],
   [ [True,  True,  True,  True,  True],   # { G }
     [True,  False, False, False, False],
     [True,  False, False, False, False],
     [True,  False, False, False, True],
     [True,  True,  True,  True,  True] ],
   [ [True,  False, False, False, True],   # { H }
     [True,  False, False, False, True],
     [True,  True,  True,  True,  True],
     [True,  False, False, False, True],
     [True,  False, False, False, True] ],
   [ [False, False, True,  False, False],  # { I }
     [False, False, True,  False, False],
     [False, False, True,  False, False],
     [False, False, True,  False, False],
     [False, False, True,  False, False] ],
   [ [False, False, True,  True,  True],   # { J }
     [False, False, False, True,  False],
     [False, False, False, True,  False],
     [False, False, False, True,  False],
     [True,  True,  True,  True,  False] ],
   [ [True,  False, False, False, True],   # { K }
     [True,  False, False, True,  False],
     [True,  True,  True,  False, False],
     [True,  False, False, True,  False],
     [True,  False, False, False, True] ],
   [ [True,  False, False, False, False],  # { L }
     [True,  False, False, False, False],
     [True,  False, False, False, False],
     [True,  False, False, False, False],
     [True,  True,  True,  True,  True] ],
   [ [True,  True,  False, True,  True],   # { N }
     [True,  False, True,  False, True],
     [True,  False, False, False, True],
     [True,  False, False, False, True],
     [True,  False, False, False, True] ],
   [ [True,  False, False, False, True],   # { M }
     [True,  True,  False, False, True],
     [True,  False, True,  False, True],
     [True,  False, False, True,  True],
     [True,  False, False, False, True] ],
   [ [False, True,  True,  True,  False],  # { O }
     [True,  False, False, False, True],
     [True,  False, False, False, True],
     [True,  False, False, False, True],
     [False, True,  True,  True,  False] ],
   [ [True,  True,  True,  True,  False],  # { P }
     [True,  False, False, False, True],
     [True,  True,  True,  True,  False],
     [True,  False, False, False, False],
     [True,  False, False, False, False] ],
   [ [True,  True,  True,  True,  True],   # { Q }
     [True,  False, False, False, True],
     [True,  False, False, False, True],
     [True,  False, False, True,  True],
     [True,  True,  True,  True,  True] ],
   [ [True,  True,  True,  True,  False],  # { R }
     [True,  False, False, False, True],
     [True,  True,  True,  True,  False],
     [True,  False, False, True,  False],
     [True,  False, False, False, True] ],
   [ [False, True,  True,  True,  True],   # { S }
     [True,  False, False, False, False],
     [False, True,  True,  True,  False],
     [False, False, False, False, True],
     [True,  True,  True,  True,  False] ],
   [ [True,  True,  True,  True,  True],   # { T }
     [False, False, True,  False, False],
     [False, False, True,  False, False],
     [False, False, True,  False, False],
     [False, False, True,  False, False] ],
   [ [True,  False, False, False, True],   # { U }
     [True,  False, False, False, True],
     [True,  False, False, False, True],
     [True,  False, False, False, True],
     [False, True,  True,  True,  False] ],
   [ [True,  False, False, False, True],   # { V }
     [True,  False, False, False, True],
     [True,  False, False, False, True],
     [False, True,  False, True,  False],
     [False, False, True,  False, False] ],
   [ [True,  False, False, False, True],   # { W }
     [True,  False, False, False, True],
     [True,  False, False, False, True],
     [True,  False, True,  False, True],
     [False, True,  False, True,  False] ],
   [ [True,  False, False, False, True],   # { X }
     [False, True,  False, True,  False],
     [False, False, True,  False, False],
     [False, True,  False, True,  False],
     [True,  False, False, False, True] ],
   [ [True,  False, False, False, True],   # { Y }
     [False, True,  False, True,  False],
     [False, False, True,  False, False],
     [False, False, True,  False, False],
     [False, False, True,  False, False] ],
   [ [True,  True,  True,  True,  True],   # { Z }
     [False, False, False, True,  False],
     [False, False, True,  False, False],
     [False, True,  False, False, False],
     [True,  True,  True,  True,  True] ],
   [ [False,  False,  False,  False,  False],   # { ' ' }
     [False, False, False, False,  False],
     [False, False, False,  False, False],
     [False, False,  False, False, False],
     [False,  False,  False,  False,  False] ],   # { , }
 [ [False,  False,  False,  False,  False],   
     [False, False, False, False,  False],
     [False, False, False,  False, False],
     [False, False,  False, True, False],
     [False,  True,  True,  False,  False] ],
  [ [False,  False,  False,  False,  False],   # { '.' }
     [False, False, False, False,  False],
     [False, False, False,  False, False],
     [False, False,  False, False, False],
     [False,  True,  False,  False,  False] ],   # { '' }
 [[False,  True,  False,  False,  False],   
     [False, False, False, False,  False],
     [False, False, False,  False, False],
     [False, False,  False, False, False],
     [False,  False,  False,  False,  False] ],
  [ [False,  False,  False,  False,  False],   # { ':' }
     [False, False, False, False,  True],
     [False, False, False,  False, False],
     [False, False,  False, False, True],
     [False,  False,  False,  False,  False] ],
 [ [True,  False,  False,  False,  False],   # { ')' }
     [False, True, False, False,  False],
     [False, True, False,  False, False],
     [False, True,  False, False, False],
     [True,  False,  False,  False,  False] ],
 [ [False,  False,  True,  False,  False],   # { '(' }
     [False, True, False, False,  False],
     [False, True, False,  False, False],
     [False, True,  False, False, False],
     [False,  False,  True,  False,  False] ], 
[ [False,  True,  False,  False,  False],   # { '!' }
     [False, True, False, False,  False],
     [False, True, False,  False, False],
     [False, False,  False, False, False],
     [False,  True,  False,  False,  False] ]]


exemple_a_reconnaitre = [ [True,  False, True,  False, True],
                          [True,  True,  False, False, True],
                          [False, False, True,  False, True],
                          [True,  False, False, True,  True],
                          [True, False, False, False, True] ]

def print_forme(forme):
    for ligne in range(5):
        for colonne in range(5):
            if(forme[ligne][colonne] == True):
                print('#', end='')
            else:
                print(' ', end='')
        print("\n", end='')

def p_alphabet():
    for forme in alphabet:
        print_forme(forme)
        print("\n")

def p_reseau(reseau):
    for ligne in range(5):
        for colonne in range(5):            
            if(reseau[5*ligne+colonne] == True):
                print('[#]', end='')
            else:
                print('[]', end='')
        print("\n", end='')
        
def m_to_l(matrix):
    result = []
    for i in range(5):
        for j in range(5):
            result.append(matrix[i][j])
            
    return result

def l_to_m(liste):
    result = []        
    for i in range(5):
        part = []
        for j in range(5):
            part.append(liste[5*i+j])
        result.append(part)    
    return result

alphab = "ABCDEFGHIJKLMNOPQRSTUVWXYZ ,.':)(!"

index = {}
ind = 0
for l in alphab:
    index[l] = ind
    ind += 1
    
def message(text):
    assemble = [[] for i in range(5)]
    
    for l in text.upper():
        forme = alphabet[index[l]]
        for ligne in range(5):
            assemble[ligne] = assemble[ligne] + forme[ligne] + [False]        
            
    for ligne in range(5):
        for lettre in assemble[ligne]:                    
            if(lettre == True):
                 print('#', end=' ')

            else:
                print(' ', end=' ')
            
        print("")

def p_poids(poids):
    poids = l_to_m(poids)
    for ligne in poids:
        print(ligne)

def iteration(etat, poids, seuils):
    R = N_cell  
    for cellule in range(R):  
        somme = 0       
        for voisine in range(R):
            if(cellule != voisine):                
                #print("etat = {}".format(etats[voisine]))
                #print("poids = {}".format(poids[cellule][voisine]))
                somme += poids[cellule][voisine] * etat[voisine]
                #print("poids * etat = {}".format(poids[cellule][voisine] * etats[voisine]))
                #print("nouvelle somme: {}".format(somme))
        #print("somme actuelle : {}\nseuil de la case : {}".format(somme, seuils[cellule]))
        suivante = somme - seuils[cellule]   
        #print(suivante)
        suivante = True if suivante > 0 else False 
        
        etat[cellule] = suivante
    return etat

def train(etat, forme, poids, seuils, eps):  
    R = N_cell
    
    for cellule in range(R):  
        somme = 0
        nb_participant = 0
        for voisine in range(R):
            if(cellule != voisine):
                if(etat[voisine] == True):
                    somme += poids[cellule][voisine]
                    nb_participant += 1          
        suivante = somme - seuils[cellule]           
        suivante = True if suivante > 0 else False                 
        
        #print("Obtenue = {}\nVoulue = {}".format(suivante, forme[cellule]))        
        
        if(suivante != forme[cellule]):                  
            erreur = forme[cellule] - suivante
            #print("erreur = {}".format(erreur))
            delta = (erreur + eps) / nb_participant
            #print("delta = {}".format(delta))
            for voisine in range(N_cell):
                 if(cellule != voisine):
                    if(etat[voisine] == True):                       
                        poids[cellule][voisine] += delta
                        poids[voisine][cellule] += delta
            
            seuils[cellule] -= delta                      
    return poids, seuils

def init():  
    import numpy as np 
    
    N = 5 # nombre de lignes (et de colonnes) d'une forme
    N_cell = N * N   
    score = 0
    performances = []
    #etat_avant = [ False for _ in range(N_cell) ]  
        
    for v_poids in np.arange(0.0, 1.0, 0.1):
        for v_seuils in np.arange(0.0, 1.0, 0.1):
           
            for v_epsilon in np.arange(0.0, 1.0, 0.1):
               
                score = 0
                
                seuils = [ v_seuils for _ in range(N_cell) ] 
                poids = [ [ v_poids for _ in range(N_cell)] for _ in range(N_cell) ]
                epsilon = v_epsilon
                
                for lettre in range(mini,maxi + 1):
                    #print("On entraine : {}".format(list(index.keys())[list(index.values()).index(lettre)]))
                    for i in range(10): # Après 10, les poids et seuils ne changent plus
                        poids, seuils = train(m_to_l(alphabet[lettre]), m_to_l(alphabet[lettre]), poids, seuils, epsilon)                        
                        
                it = 10
                for letter in range(mini, maxi + 1):                                   
                    forme = alphabet[letter] 
                    etat_apres = m_to_l(forme)                                       
                    
                    for i in range(it):
                        etat_apres = iteration(etat_apres, poids, seuils)
                                            
                    if(m_to_l(forme) == etat_apres):
                        #print("{} {} {}".format(v_poids, v_seuils, v_epsilon))                       
                        score += 1
                        #print("score : {}".format(score))
                performances.append([score, v_poids, v_seuils, v_epsilon])
                #print(performances)
    indice = 0
    indice_max = 0
    score_max = 0
    for v_score in performances:
        if(v_score[0] > score_max):
            score_max = v_score[0]
            indice_max = indice
        
        indice += 1
    print(indice_max)
    
    return performances[indice_max][0], performances[indice_max][1], performances[indice_max][2], performances[indice_max][3]

mini = index["M"]
maxi = index["N"]

import time

N = 5 # nombre de lignes (et de colonnes) d'une forme

N_cell = N*N
'''
v_poids = 0.5
v_epsilon = 0.2
v_seuils = 0.0
'''

start_time = time.time()

max_score, v_poids, v_seuils, v_epsilon = init()
print("--- %s seconds ---" % (time.time() - start_time))
print("max_score = {}\npoids = {}\nseuils = {}\nepsilon = {}".format(max_score, v_poids, v_seuils, v_epsilon))
# états des cellules du réseau (booléens)
etats = [ False for _ in range(N_cell) ]

# seuils des cellules du réseau (réels)
seuils = [ v_seuils for _ in range(N_cell) ]

# poids des connexions du réseau (réels)
poids = [ [ v_poids for _ in range(N_cell)] for _ in range(N_cell) ]

epsilon = v_epsilon # La marge de sécurité   

#epsilon = -0.01
for lettre in range(mini, maxi + 1):
    #print("On entraine : {}".format(list(index.keys())[list(index.values()).index(lettre)]))
    for i in range(10): # Après 10, les poids et seuils ne changent plus
        poids, seuils = train(m_to_l(alphabet[lettre]), m_to_l(alphabet[lettre]), poids, seuils, epsilon)   

# Affichage du résultat de l'entrainement
it = 10
for letter in range(mini ,maxi+ 1):                                
    forme = alphabet[letter]                               
    print_forme(forme)
    etat_apres = m_to_l(forme)                                    

    for i in range(it):
        etat_apres = iteration(etat_apres, poids, seuils)
    
    print_forme(l_to_m(etat_apres))
    print("\n")

# La forme à reconnaître
it = 10
forme = exemple_a_reconnaitre
print_forme(forme)
etats = m_to_l(forme)
print("\n")
for i in range(it):
    etats = iteration(etats, poids, seuils)
print_forme(l_to_m(etats))
